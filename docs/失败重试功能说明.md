# 失败重试功能说明

## 问题修复

### 1. 错误统计问题修复

**问题描述：**
- 之前当API返回的JSON解析失败时，错误没有被正确统计到progress.json中
- 原因是`universal_llm.py`中的错误处理返回`None`而不是抛出异常

**解决方案：**
- 修改`universal_llm.py`中的`_parse_success_response`方法，将所有错误情况改为抛出异常
- 修改`processor.py`中的错误处理逻辑，正确区分和统计不同类型的错误：
  - `json_error`: JSON解析错误
  - `api_error`: API调用错误
  - `other_error`: 其他错误

### 2. 失败记录重试功能

**新增功能：**
程序现在支持重新处理失败的记录，通过读取error文件并重新调用API处理。

## 使用方法

### 正常处理模式（原有功能）

```bash
python main.py <input_file> <prompt_file> [options]
```

示例：
```bash
python main.py "inputData/01-新增社会品名大模型输出结果_百科概述-8142未匹配.xlsx" "prompts/baike.txt"
```

### 失败重试模式（新增功能）

```bash
python main.py <input_file> <prompt_file> --retry-errors
```

示例：
```bash
python main.py "inputData/01-新增社会品名大模型输出结果_百科概述-8142未匹配.xlsx" "prompts/baike.txt" --retry-errors
```

## 工作流程

### 第一次处理
1. 运行正常处理命令
2. 程序会生成以下文件：
   - `*_output.xlsx/csv`: 成功处理的记录
   - `*_error.xlsx/csv`: 失败的记录
   - `*_progress.json`: 进度和统计信息
   - `*_process.log`: 处理日志
   - `*_raw.json`: 原始API返回结果

### 查看失败统计
检查 `*_progress.json` 文件：
```json
{
  "last_position": 8142,
  "last_update": "2025-11-05T14:59:50.206998",
  "stats": {
    "total": 8142,
    "success": 8136,
    "api_error": 0,
    "empty_result": 0,
    "json_error": 6,    // 现在会正确统计
    "other_error": 0
  }
}
```

### 重试失败记录
1. 当发现有失败记录时，运行重试命令：
   ```bash
   python main.py <input_file> <prompt_file> --retry-errors
   ```

2. 程序会：
   - 读取 `*_error.xlsx/csv` 文件
   - 备份错误文件到 `backups/` 目录
   - 清空错误文件准备记录新的错误
   - 重新处理所有失败的记录
   - 成功的记录会追加到 `*_output.xlsx/csv`
   - 仍然失败的记录会重新写入 `*_error.xlsx/csv`
   - 生成 `*_retry.log` 日志文件

3. 查看重试结果：
   ```
   重试完成。统计信息:
   总记录: 6
   成功: 5
   API错误: 0
   JSON解析错误: 1
   其他错误: 0
   ```

### 多次重试
如果第一次重试后仍有失败记录，可以继续运行重试命令：
```bash
python main.py <input_file> <prompt_file> --retry-errors
```

程序会继续处理剩余的失败记录，直到所有记录都成功或确认无法处理。

## 命令行参数

```
usage: main.py [-h] [--config CONFIG] [--fields FIELDS] [--start-pos START_POS]
               [--end-pos END_POS] [--provider PROVIDER] [--output OUTPUT]
               [--retry-errors]
               input_path prompt_file

必选参数:
  input_path            输入文件或目录的路径
  prompt_file           提示词文件路径

可选参数:
  -h, --help            显示帮助信息
  --config CONFIG       配置文件路径（默认: config/config.yaml）
  --fields FIELDS       要处理的输入字段，格式：1,2,3 或 1-5
  --start-pos START_POS 开始处理的位置（从1开始，默认: 1）
  --end-pos END_POS     结束处理的位置（包含）
  --provider PROVIDER   指定API提供商
  --output OUTPUT       指定输出目录路径（默认: outputData）
  --retry-errors        重试失败的记录
```

## 注意事项

1. **文件备份**：每次重试前会自动备份错误文件到 `backups/` 目录
2. **增量追加**：重试成功的记录会追加到输出文件，不会覆盖已有的成功记录
3. **日志分离**：重试会生成独立的日志文件 `*_retry.log`
4. **错误类型**：程序现在能正确区分和统计不同类型的错误
5. **重复重试**：可以多次运行重试命令，直到所有记录都成功

## 示例场景

### 场景1：首次处理有错误
```bash
# 第一次处理
python main.py "inputData/data.xlsx" "prompts/prompt.txt"

# 查看progress.json发现有6条失败
# 运行重试
python main.py "inputData/data.xlsx" "prompts/prompt.txt" --retry-errors

# 重试后5条成功，1条仍失败
# 可以再次重试
python main.py "inputData/data.xlsx" "prompts/prompt.txt" --retry-errors
```

### 场景2：指定不同的提供商重试
```bash
# 如果觉得是API提供商的问题，可以换一个试试
python main.py "inputData/data.xlsx" "prompts/prompt.txt" --retry-errors --provider deepseek
```

## 技术细节

### 错误类型分类
- **json_error**: JSON格式错误、解析失败
- **api_error**: API调用失败、网络错误、认证错误等
- **other_error**: 其他未分类的错误

### 错误文件格式
**CSV格式：**
```csv
content,error_type
"原始输入内容",JSON解析错误
```

**JSON格式：**
```json
{
  "content": "原始输入内容",
  "error_type": "JSON解析错误",
  "error_details": "具体错误信息",
  "raw_content": "LLM返回的原始文本内容（前500字符）"
}
```

**Excel格式：**
与CSV类似，包含content和error_type列

### raw.json 文件格式（新版本）

从此版本开始，`raw.json` 保存**所有**API响应的原始内容，包括解析失败的记录：

```json
{
  "raw_response": "完整的API响应JSON字符串",
  "raw_content": "LLM返回的原始文本内容",
  "input": "输入的提示内容"
}
```

详细说明请参考 [raw_json格式说明.md](./raw_json格式说明.md)

## 疑难解答

### Q: 为什么之前的错误没有被统计？
A: 这是一个已修复的bug。现在所有错误都会被正确统计。

### Q: 重试会覆盖之前的成功记录吗？
A: 不会。重试成功的记录会追加到输出文件末尾。

### Q: 可以重试多少次？
A: 没有限制。可以一直重试直到所有记录成功或确认无法处理。

### Q: 如何查看重试日志？
A: 查看 `outputData/*_retry.log` 文件。

### Q: 错误文件在哪里？
A: 在 `outputData/` 目录下，文件名为 `<原始文件名>_error.<扩展名>`

